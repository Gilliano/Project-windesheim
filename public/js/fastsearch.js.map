{"version":3,"sources":["fastsearch.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"fastsearch.js","sourcesContent":["(function(factory) {\n\n    if (typeof define === 'function' && define.amd) {\n        define(['jquery'], factory);\n    } else if (typeof module === 'object' && module.exports) {\n        module.exports = factory(require('jquery'));\n    } else {\n        factory(jQuery);\n    }\n\n}(function($) {\n\n    var $document = $(window.document),\n        instanceNum = 0,\n        eventStringRE = /\\w\\b/g,\n        keyMap = {\n            13: 'enter',\n            27: 'escape',\n            40: 'downArrow',\n            38: 'upArrow'\n        };\n\n    function Fastsearch(inputElement, options) {\n\n        this.init.apply(this, arguments);\n\n    }\n\n    $.extend(Fastsearch.prototype, {\n\n        init: function(inputElement, options) {\n\n            options = this.options = $.extend(true, {}, Fastsearch.defaults, options);\n\n            this.$input = $(inputElement);\n            this.$el = options.wrapSelector instanceof $ ? options.wrapSelector : this.$input.closest(options.wrapSelector);\n\n            Fastsearch.pickTo(options, this.$el.data(), [\n                'url', 'onItemSelect', 'noResultsText', 'inputIdName', 'apiInputName'\n            ]);\n\n            options.url = options.url || this.$el.attr('action');\n\n            this.ens = '.fastsearch' + (++instanceNum);\n            this.itemSelector = Fastsearch.selectorFromClass(options.itemClass);\n            this.focusedItemSelector = Fastsearch.selectorFromClass(options.focusedItemClass);\n\n            this.events();\n\n        },\n\n        namespaceEvents: function(events) {\n\n            var eventNamespace = this.ens;\n\n            return events.replace(eventStringRE, function(match) {\n                return match + eventNamespace;\n            });\n\n        },\n\n        events: function() {\n\n            var self = this,\n                options = this.options;\n\n            this.$input.on(this.namespaceEvents('keyup focus click'), function(e) {\n\n                keyMap[e.keyCode] !== 'enter' && self.handleTyping();\n\n            }).on(this.namespaceEvents('keydown'), function(e) {\n\n                keyMap[e.keyCode] === 'enter' && options.preventSubmit && e.preventDefault();\n\n                if (self.hasResults && self.resultsOpened) {\n\n                    switch (keyMap[e.keyCode]) {\n                        case 'downArrow': e.preventDefault(); self.navigateItem('down'); break;\n                        case 'upArrow': e.preventDefault(); self.navigateItem('up'); break;\n                        case 'enter': self.onEnter(e); break;\n                    }\n\n                }\n\n            });\n\n            this.$el.on(this.namespaceEvents('click'), this.itemSelector, function(e) {\n\n                e.preventDefault();\n                self.handleItemSelect($(this));\n\n            });\n\n            options.mouseEvents && this.$el.on(this.namespaceEvents('mouseleave'), this.itemSelector, function(e) {\n\n                $(this).removeClass(options.focusedItemClass);\n\n            }).on(this.namespaceEvents('mouseenter'), this.itemSelector, function(e) {\n\n                self.$resultItems.removeClass(options.focusedItemClass);\n                $(this).addClass(options.focusedItemClass);\n\n            });\n\n        },\n\n        handleTyping: function() {\n\n            var inputValue = $.trim(this.$input.val()),\n                self = this;\n\n            if (inputValue.length < this.options.minQueryLength) {\n\n                this.hideResults();\n\n            } else if (inputValue === this.query) {\n\n                this.showResults();\n\n            } else {\n\n                clearTimeout(this.keyupTimeout);\n\n                this.keyupTimeout = setTimeout(function() {\n\n                    self.$el.addClass(self.options.loadingClass);\n\n                    self.query = inputValue;\n\n                    self.getResults(function(data) {\n\n                        self.showResults(self.storeResponse(data).generateResults(data));\n\n                    });\n\n                }, this.options.typeTimeout);\n\n            }\n\n        },\n\n        getResults: function(callback) {\n\n            var self = this,\n                options = this.options,\n                formValues = this.$el.find('input, textarea, select').serializeArray();\n\n            if (options.apiInputName) {\n                formValues.push({'name': options.apiInputName, 'value': this.$input.val()});\n            }\n\n            $.get(options.url, formValues, function(data) {\n\n                callback(options.parseResponse ? options.parseResponse.call(self, data, self) : data);\n\n            });\n\n        },\n\n        storeResponse: function(data) {\n\n            this.responseData = data;\n            this.hasResults = data.length !== 0;\n\n            return this;\n\n        },\n\n        generateResults: function(data) {\n\n            var $allResults = $('<div>'),\n                options = this.options;\n\n            if (options.template) {\n                return $(options.template(data, this));\n            }\n\n            if (data.length === 0) {\n\n                $allResults.html(\n                    '<p class=\"' + options.noResultsClass + '\">' +\n                        (typeof options.noResultsText === 'function' ? options.noResultsText.call(this) : options.noResultsText) +\n                    '</p>'\n                );\n\n            } else {\n\n                if (this.options.responseType === 'html') {\n\n                    $allResults.html(data);\n\n                } else {\n\n                    this['generate' + (data[0][options.responseFormat.groupItems] ? 'GroupedResults' : 'SimpleResults')](data, $allResults);\n\n                }\n\n            }\n\n            return $allResults.children();\n\n        },\n\n        generateSimpleResults: function(data, $cont) {\n\n            var self = this;\n\n            this.itemModels = data;\n\n            $.each(data, function(i, item) {\n                $cont.append(self.generateItem(item));\n            });\n\n        },\n\n        generateGroupedResults: function(data, $cont) {\n\n            var self = this,\n                options = this.options,\n                format = options.responseFormat;\n\n            this.itemModels = [];\n\n            $.each(data, function(i, groupData) {\n\n                var $group = $('<div class=\"' + options.groupClass + '\">').appendTo($cont);\n\n                groupData[format.groupCaption] && $group.append(\n                    '<h3 class=\"' + options.groupTitleClass + '\">' + groupData[format.groupCaption] + '</h3>'\n                );\n\n                $.each(groupData.items, function(i, item) {\n\n                    self.itemModels.push(item);\n                    $group.append(self.generateItem(item));\n\n                });\n\n                options.onGroupCreate && options.onGroupCreate.call(self, $group, groupData, self);\n\n            });\n\n        },\n\n        generateItem: function(item) {\n\n            var options = this.options,\n                format = options.responseFormat,\n                url = item[format.url],\n                html = item[format.html] || item[format.label],\n                $tag = $('<' + (url ? 'a' : 'span') + '>').html(html).addClass(options.itemClass);\n\n            url && $tag.attr('href', url);\n\n            options.onItemCreate && options.onItemCreate.call(this, $tag, item, this);\n\n            return $tag;\n\n        },\n\n        showResults: function($content) {\n\n            if (!$content && this.resultsOpened) {\n                return;\n            }\n\n            this.$el.removeClass(this.options.loadingClass).addClass(this.options.resultsOpenedClass);\n\n            if (this.options.flipOnBottom) {\n                this.checkDropdownPosition();\n            }\n\n            this.$resultsCont = this.$resultsCont || $('<div>').addClass(this.options.resultsContClass).appendTo(this.$el);\n\n            if ($content) {\n\n                this.$resultsCont.html($content);\n                this.$resultItems = this.$resultsCont.find(this.itemSelector);\n                this.options.onResultsCreate && this.options.onResultsCreate.call(this, this.$resultsCont, this.responseData, this);\n\n            }\n\n            if (!this.resultsOpened) {\n\n                this.documentCancelEvents('on');\n                this.$input.trigger('openingResults');\n\n            }\n\n            if (this.options.focusFirstItem && this.$resultItems && this.$resultItems.length) {\n                this.navigateItem('down');\n            }\n\n            this.resultsOpened = true;\n\n        },\n\n        checkDropdownPosition: function() {\n\n            var flipOnBottom = this.options.flipOnBottom;\n            var offset = typeof flipOnBottom === 'boolean' && flipOnBottom ? 400 : flipOnBottom;\n            var isFlipped = this.$input.offset().top + offset > $document.height();\n\n            this.$el.toggleClass(this.options.resultsFlippedClass, isFlipped);\n\n        },\n\n        documentCancelEvents: function(setup, onCancel) {\n\n            var self = this;\n\n            if (setup === 'off' && this.closeEventsSetuped) {\n\n                $document.off(this.ens);\n                this.closeEventsSetuped = false;\n                return;\n\n            } else if (setup === 'on' && !this.closeEventsSetuped) {\n\n                $document.on(this.namespaceEvents('click keyup'), function(e) {\n\n                    if (keyMap[e.keyCode] === 'escape' || (!$(e.target).is(self.$el) && !$.contains(self.$el.get(0), e.target) && $.contains(document.documentElement, e.target))) {\n\n                        onCancel ? onCancel.call(self) : self.hideResults();\n\n                    }\n\n                });\n\n                this.closeEventsSetuped = true;\n\n            }\n\n        },\n\n        navigateItem: function(direction) {\n\n            var $currentItem = this.$resultItems.filter(this.focusedItemSelector),\n                maxPosition = this.$resultItems.length - 1;\n\n            if ($currentItem.length === 0) {\n\n                this.$resultItems.eq(direction === 'up' ? maxPosition : 0).addClass(this.options.focusedItemClass);\n                return;\n\n            }\n\n            var currentPosition = this.$resultItems.index($currentItem),\n                nextPosition = direction === 'up' ? currentPosition - 1 : currentPosition + 1;\n\n            nextPosition > maxPosition && (nextPosition = 0);\n            nextPosition < 0 && (nextPosition = maxPosition);\n\n            $currentItem.removeClass(this.options.focusedItemClass);\n\n            this.$resultItems.eq(nextPosition).addClass(this.options.focusedItemClass);\n\n        },\n\n        navigateDown: function() {\n\n            this.navigateItem('down');\n\n        },\n\n        navigateUp: function() {\n\n            this.navigateItem('up');\n\n        },\n\n        onEnter: function(e) {\n\n            var $currentItem = this.$resultItems.filter(this.focusedItemSelector);\n\n            if ($currentItem.length) {\n                e.preventDefault();\n                this.handleItemSelect($currentItem);\n            }\n\n        },\n\n        handleItemSelect: function($item) {\n\n            var selectOption = this.options.onItemSelect,\n                model = this.itemModels.length ? this.itemModels[this.$resultItems.index($item)] : {};\n\n            this.$input.trigger('itemSelected');\n\n            if (selectOption === 'fillInput') {\n\n                this.fillInput(model);\n\n            } else if (selectOption === 'follow') {\n\n                window.location.href = $item.attr('href');\n\n            } else if (typeof selectOption === 'function') {\n\n                selectOption.call(this, $item, model, this);\n\n            }\n\n        },\n\n        fillInput: function(model) {\n\n            var options = this.options,\n                format = options.responseFormat;\n\n            this.query = model[format.label];\n            this.$input.val(model[format.label]).trigger('change');\n\n            if (options.fillInputId && model.id) {\n\n                if (!this.$inputId) {\n\n                    var inputIdName = options.inputIdName || this.$input.attr('name') + '_id';\n\n                    this.$inputId = this.$el.find('input[name=\"' + inputIdName + '\"]');\n\n                    if (!this.$inputId.length) {\n                        this.$inputId = $('<input type=\"hidden\" name=\"' + inputIdName + '\" />').appendTo(this.$el);\n                    }\n\n                }\n\n                this.$inputId.val(model.id).trigger('change');\n\n            }\n\n            this.hideResults();\n\n        },\n\n        hideResults: function() {\n\n            if (this.resultsOpened) {\n\n                this.resultsOpened = false;\n                this.$el.removeClass(this.options.resultsOpenedClass);\n                this.$input.trigger('closingResults');\n                this.documentCancelEvents('off');\n\n            }\n\n            return this;\n\n        },\n\n        clear: function() {\n\n            this.hideResults();\n            this.$input.val('').trigger('change');\n\n            return this;\n\n        },\n\n        destroy: function() {\n\n            $document.off(this.ens);\n\n            this.$input.off(this.ens);\n\n            this.$el.off(this.ens)\n                .removeClass(this.options.resultsOpenedClass)\n                .removeClass(this.options.loadingClass);\n\n            if (this.$resultsCont) {\n\n                this.$resultsCont.remove();\n                delete this.$resultsCont;\n\n            }\n\n            delete this.$el.data().fastsearch;\n\n        }\n\n    });\n\n    $.extend(Fastsearch, {\n\n        pickTo: function(dest, src, keys) {\n\n            $.each(keys, function(i, key) {\n                dest[key] = (src && src[key]) || dest[key];\n            });\n\n            return dest;\n\n        },\n\n        selectorFromClass: function(classes) {\n\n            return '.' + classes.replace(/\\s/g, '.');\n\n        }\n\n    });\n\n    Fastsearch.defaults = {\n        wrapSelector: 'form', // fastsearch container defaults to closest form. Provide selector for something other\n        url: null, // plugin will get data from data-url propery, url option or container action attribute\n        responseType: 'JSON', // default expected server response type - can be set to html if that is what server returns\n        preventSubmit: false, // prevent submit of form with enter keypress\n\n        resultsContClass: 'fs_results', // html classes\n        resultsOpenedClass: 'fsr_opened',\n        resultsFlippedClass: 'fsr_flipped',\n        groupClass: 'fs_group',\n        itemClass: 'fs_result_item',\n        groupTitleClass: 'fs_group_title',\n        loadingClass: 'loading',\n        noResultsClass: 'fs_no_results',\n        focusedItemClass: 'focused',\n\n        typeTimeout: 140, // try not to hammer server with request for each keystroke if possible\n        minQueryLength: 2, // minimal number of characters needed for plugin to send request to server\n\n        template: null, // provide your template function if you need one - function(data, fastsearchApi)\n        mouseEvents: !('ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0), // detect if client is touch enabled so plugin can decide if mouse specific events should be set.\n        focusFirstItem: false,\n        flipOnBottom: false,\n\n        responseFormat: { // Adjust where plugin looks for data in your JSON server response\n            url: 'url',\n            html: 'html',\n            label: 'label',\n            groupCaption: 'caption',\n            groupItems: 'items'\n        },\n\n        fillInputId: true, // on item select plugin will try to write selected id from item data model to input\n        inputIdName: null, // on item select plugin will try to write selected id from item data model to input with this name\n\n        apiInputName: null, // by default plugin will post input name as query parameter - you can provide custom one here\n\n        noResultsText: 'No results found',\n        onItemSelect: 'follow', // by default plugin follows selected link - other options available are \"fillInput\" and custom callback - function($item, model, fastsearchApi)\n\n        parseResponse: null, // parse server response with your handler and return processed data - function(response, fastsearchApi)\n        onResultsCreate: null, // adjust results element - function($allResults, data, fastsearchApi)\n        onGroupCreate: null, // adjust group element when created - function($group, groupModel, fastsearchApi)\n        onItemCreate: null // adjust item element when created - function($item, model, fastsearchApi)\n    };\n\n    $.fastsearch = Fastsearch;\n\n    $.fn.fastsearch = function(options) {\n        return this.each(function() {\n            if (!$.data(this, 'fastsearch')) {\n                $.data(this, 'fastsearch', new Fastsearch(this, options));\n            }\n        });\n    };\n\n    return $;\n\n}));\n"]}